<!doctype html>


<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />

	<title>Category</title>

	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="/styles/main.css" />
	<link rel="stylesheet" type="text/css" href="/styles/content.css" />
	<link rel="stylesheet" type="text/css" href="/styles/microsoft.css" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>

<body class="category">
	<header>
		<nav>
			<input class="trigger" type="checkbox" id="hamburger" />
			<a class="github" href="https://github.com/DamSenViet/LAHacks-Improved"><img src="/icons/github.svg"/></a>
			<a class="logo" href="/">Browse</a>
			<label class="right hamburger center-parent mobile" for="hamburger">
					<div class="center">
						<div class="top bar"></div>
						<div class="middle bar"></div>
						<div class="bottom bar"></div>
					</div>
				</label>

			<div class="menu-items">
				<div class="search">
					<input type="text" list="suggestions" placeholder="Search..." />

					<datalist id="suggestions">
					</datalist>
				</div>

				<% if (!isAuthenticated) { %>
				<a class="main" href="/login"><span class="centered-text">Login</span></a>
				<a class="main" href="/signup"><span class="centered-text">Sign Up</span></a>

				<% } else { %>

				<div class="dropdown settings">
					<a class="main"><%=username %></a>
					<ul>
						<li><a class="user-icon">Profile</a></li>
						<li><a class="gear-icon">Settings</a></li>
					</ul>
				</div>
				<% } %>

				<div class="dropdown categories">
					<a class="main desktop">Categories</a>
					<ul class="desktop">
						<% for (let i = 0; i < categories.length; ++i) { %>
							<li><a href="<%= '/category/'+categories[i].unmodifiedName %>"><%= categories[i].name %></a></li>
						<% } %>
					</ul>

					<div class="select-wrapper mobile">
						<select>
							<option disabled selected hidden>Categories</option>
							<% for (let i = 0; i < categories.length; ++i) { %>
								<option value="<%= '/category/'+categories[i].unmodifiedName %>"><%= categories[i].name %></option>
							<% } %>
						</select>
					</div>
				</div>


			</div>
		</nav>
	</header>

	<main class="category">
		<div class="floating-add">
			<img src="/icons/camera.svg" class="icon" />
		</div>

		<div class="close-out">
			<div class="bar"></div>
			<div class="bar"></div>
		</div>

	</main>

	<script>
		function whichTransitionEvent() {
			var el = document.createElement('fakeelement');
			var transitions = {
				'transition': 'transitionend',
				'OTransition': 'oTransitionEnd',
				'MozTransition': 'transitionend',
				'WebkitTransition': 'webkitTransitionEnd'
			}

			for (var t in transitions) {
				if (el.style[t] !== undefined) {
					return transitions[t];
				}
			}
			return transitions['transition'];
		}
		var transitionEnd = whichTransitionEvent();


		$('.floating-add').click(function() {
			setTimeout(function() {
				window.location.href = '/category/<%= unmodifiedCategoryName %>/upload';
			}, 200);
		});


		function animate(card) {
			// FIRST position before transform
			// LAST position after transform
			let first;
			let last;
			if (!$(card).hasClass('active')) {
				// reset all other animation states
				$('.card').removeClass('animate final');

				// adding active
				first = card.getBoundingClientRect();
				$(card).addClass('active');
				$('body').addClass('active');
				last = card.getBoundingClientRect();

				// add placeholder element
				var emptyCard = "<div class='card placeholder'><div class='image-container'><div class='overlay-container'><div class='image'></div><div class='content'></div></div></div></div>"
				$(emptyCard).insertAfter(card);

			} else {
				// delete placeholder first to make sure first and last are correct
				$('.placeholder').remove();

				// removing active using image instead
				// prevents image distortion
				let image =  card.querySelector('.image');
				first = image.getBoundingClientRect();
				$(card).removeClass('active');
				$('body').removeClass('active');
				last = image.getBoundingClientRect();
			}


			// get current position and scales
			let invert = {
				// position
				x: first.left - last.left,
				y: first.top - last.top,
				// scales
				sx: first.width / last.width,
				sy: first.height / last.height
			};

			// transforms to the current position according to scaling
			card.style.transform = 'translate(' + invert.x + 'px, ' + invert.y + 'px) scale(' + invert.sx + ', ' + invert.sy + ')';

			// PLAY
			window.requestAnimationFrame(function() {
				card.classList.add('animate');
				// reset transform to have it move back into its proper place
				card.style.transform = "";

				// activating card, add final state in the middle of 'animate'
				if (card.classList.contains('active')) {
					card.classList.add('final');
				}

				// CLEAR, moves to desired position once animate transition ends
				card.addEventListener(transitionEnd, clearCardAnimation);
			});
		};

		// CLEAR ANIMATION PHASE
		function clearCardAnimation(event) {
			this.classList.remove('animate');
			this.removeEventListener(transitionEnd, clearCardAnimation);
		};

		// ATTACH HANDLER WHEN NO CARDS ARE ACTIVE
		// REMOVE HANDLER WHEN ONE CARD ACTIVE
		function attachFocusToCards() {
			$('.card').click(function() {
				// remove transition applied from request
				$(this).attr('style', '');
				// remove handler from all cards after clicking, continue
				$('.card').unbind();
				try {
					// animate the clicked card
					animate(this);
				} catch (err) {return null;}
			});
		};


		$('.close-out').click(function() {
			let activeCard = document.querySelector('.card.active');

			// clearCardAnimation manually for high speed error correction
			// when close out is activated too fast, before clearCardAnimation activates
			// from transitionEnd, animate will stay there forever b/c it's never
			// cleared, even in consecutive calls, therefore need to manually clear transitionEnd
			try {
				activeCard.removeEventListener(transitionEnd, clearCardAnimation);
				// need this to kill left behind placeholder bug
				$('.card').removeClass('animate final');
			} catch (error) {return null;}

			// remove final first before inducing animation
			animate(activeCard);
			attachFocusToCards();

			// remove focus from inputs inside the card
			$('.reply').blur();
		});

		$(document).keyup(function(e) {
			if (e.keyCode == 27) {
				$('.close-out').click();
			}
		});

		// PREVENT EVENT BUBBLING FROM TRIGGERING TRANSITION END OF PARENT ('.CARD')
		// prevents some race conditions
		function stopCardTransitionBubble () {
			$('.card > *').on('transitionend', function(event) {
				event.stopImmediatePropagation();
			});
		};

		function textAreaAutoAdjust(event) {
			this.style.height = '';
			this.style.height = this.scrollHeight + 'px';
		}

		function attachTextAreaAutoAdjust() {
			$('textarea.reply').on('input', textAreaAutoAdjust);
		};

		function textAreaCommentKeys(event) {
			// ctrl + enter -> newline
			if (event.ctrlKey && event.keyCode ==13) {
				event.preventDefault();
				this.value += "\n";
				$(this).trigger('input');
			}
			// enter -> send comment
			else if (event.keyCode == 13) {
				event.preventDefault();
				// send out comment POST request
			}
		};

		function attachTextAreaCommentKeys() {
			$('textarea.reply').on('keydown', textAreaCommentKeys);
		};

		// prevent event bubbling + ensure smooth animation
		function disableLike(event) {
			event.stopImmediatePropagation();
			//disable clicking until animation has finished
			$(this).unbind('click');
			$(this).on('click', function(event){
				event.stopImmediatePropagation();
				event.preventDefault();
			});

			// reenable like after animation completes
			// since this is a label, the input DOESN'T change checked state until after
			// this click trigger has finished running
			let resetTime = 0;
			if ($(this).siblings('.like-input').prop('checked') === true) {
				resetTime = 205
			} else if ($(this).siblings('.like-input').prop('checked') === false) {
				resetTime = 305
			}
			// built with async in mind
			// this function will work with like request; during like request, the like-input is disabled
			// even if like-button is pressed, it won't trigger the change since the input is disabled
			// once request is finished, then like-input will be able to affect like-button again while allowing
			// animation to completely finish
			let likebutton = this; // outside reference, this context lost in setTimeout
			setTimeout(function(event) {
				$(likebutton).unbind();
				$(likebutton).on('click', disableLike);
			}, resetTime);
		}

		function attachDisableLike() {
			$('.like-button').on('click', disableLike);
		};

		function attachLike() {
			$('.like-input').on('click', function(event) {
				event.stopImmediatePropagation();
			});
			$('.like-input').on('change', function(event) {
				// need outside refernece inside ajax
				let likeInput = this;
				$(likeInput).prop('disabled', true);
				$.ajax({
					url: "/like",
					type: "POST",
					data: JSON.stringify({
						postId: $(likeInput).data('post-id'),
						liked: $(likeInput).prop('checked'),
					}),
					contentType: "application/json",
					dataType: "text",
					success: function(res, status, xhr) {
						// do nothing
					},
					error: function(xhr, status, error) {
						window.alert("like for postId " + $(likeInput).data('postId') + " failed");
						console.log(xhr.responseText)
						console.log(error);
					},
					complete: function(xhr, status) {
						$(likeInput).prop('disabled', false);
					}
				});
			});
		};

		var cardsOffset = 0;
		// postId (string) -> commentOffSet
		var commentsOffset = {};
		function addCards() {
			// disable trigger while it's workin


			// gets cards, not comments
			$.ajax({
				url: "/category/<%= unmodifiedCategoryName %>/cards",
				type: "POST",
				data: JSON.stringify({cardsOffset: cardsOffset}),
				contentType: "application/json",
				dataType: 'json',
				success: function(res, status, xhr) {
					// success response structure
					// [{postId, postTitle, imageLink, liked, author, description}]

					let cards = xhr.responseJSON;
					cardsOffset += cards.length;

					for (let i = 0; i < cards.length; ++i) {
						let postId = cards[i].postId;
						let postTitle = cards[i].postTitle;
						let imageLink = cards[i].imageLink;
						let liked = cards[i].liked;
						let author = cards[i].author;
						let description = cards[i].description;

						commentsOffset[postId] = 0;

						let card = [
							"<div class='card sliding-in' style='transition: opacity 0.3s ease-out, transform 0.4s ease-out, pointer-events 0s linear 0.4s;' data-post-id='"+postId+"'>",
								"<div class='image-container'>",
									"<div class='overlay-container'>",
										"<div class='image' style='background-image: url("+imageLink+")'>",
										"</div>",

										"<div class='content'>",
											"<div class='title'>",
												postTitle,
											"</div>",

											<% if (isAuthenticated) { %>
												// disable like-button for unauthenticated
											"<div class='like-wrapper'>",
												"<input id='"+postId+"' type='checkbox' class='like-input' data-post-id='"+postId+"' "+ ((liked)? "checked": "")+"/>",
												"<label for='"+postId+"' class='like-button'></label>",
											"</div>",
											<% } %>

											"<div class='author'>",
												"by <a class='author-name' href='/profile/"+author+"'>"+author+"</a>",
											"</div>",

											"<div class='description'>",
												description,
											"</div>",

											"<div class='comments'>",
												"<div>",
													"<span class='view-more-comments'>View more comments...</span>",
												"</div>",
												<% if (isAuthenticated) { %>
												// disable commenting for non-authenticated users
												"<textarea class='reply post-reply' placeholder='Write a comment...' rows='1' data-post-id='"+postId+"'></textarea>",
												<% } %>
											"</div>",
										"</div>",
									"</div>",
								"</div>",
							"</div>"
						].join('\n');

						let element = $(card);
						$('main').append(element);

						// animations
						window.setTimeout(function(){
							$(element).removeClass('sliding-in');
							window.setTimeout(function() {
								$(element).attr('style', '');
							}, 300);
						}, 100 * i);
					}

					// support animation and functionality on every card
					stopCardTransitionBubble();
					attachFocusToCards();
					attachTextAreaAutoAdjust();
					attachTextAreaCommentKeys();
					attachLike();
					attachDisableLike();
				},
				error: function(xhr, status, error) {
					console.log(xhr.responseText);
				},
				complete: function(xhr, status) {
					// reenable function on scroll, reenable trigger

				}
			});
		}

		// for prototype
		stopCardTransitionBubble();
		attachFocusToCards();
		attachTextAreaAutoAdjust();
		attachTextAreaCommentKeys();
		attachLike();
		attachDisableLike();


	</script>
	<script src="/scripts/main.js"></script>
</body>
</html>
